<!DOCTYPE html>
<html lang="fr" class="scrollbar-hide">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin V2 - DraftPrime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: white; font-family: system-ui, sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
  </style>
</head>
<body class="min-h-screen p-6">

  <div id="app" class="max-w-4xl mx-auto">
    
    <!-- HEADER -->
    <div class="flex justify-between items-center mb-10">
        <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
            ADMINISTRATEUR
        </h1>
        <button id="refresh-btn" class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition">
            ↻ Rafraîchir
        </button>
    </div>

    <!-- LOGIN -->
    <div id="login-admin" class="max-w-md mx-auto glass p-8 rounded-2xl shadow-2xl">
      <h2 class="text-xl font-bold mb-6">Connexion Requise</h2>
      <form id="login-form" class="space-y-4">
        <input name="email" type="email" placeholder="Email Admin" class="w-full px-4 py-3 rounded-lg bg-black/50 border border-white/10 text-white focus:ring-pink-500" required>
        <input name="password" type="password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-lg bg-black/50 border border-white/10 text-white focus:ring-pink-500" required>
        <button class="w-full py-3 rounded-lg bg-pink-600 font-bold hover:bg-pink-500 transition">Se connecter</button>
        <p id="login-error" class="text-red-400 text-sm text-center"></p>
      </form>
    </div>

    <!-- LISTE -->
    <div id="contributions-list" class="hidden space-y-6">
        <!-- Injecté par JS -->
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDOqn7DJSB-FtTfSj1-6RE8vzznyxNhjNw",
      authDomain: "projetvie-212e4.firebaseapp.com",
      projectId: "projetvie-212e4",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentToken = null;

    const loginDiv = document.getElementById('login-admin');
    const listDiv = document.getElementById('contributions-list');
    
    // LOGIN
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
      } catch (error) {
        document.getElementById('login-error').textContent = error.message;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentToken = await user.getIdToken();
        loginDiv.classList.add('hidden');
        listDiv.classList.remove('hidden');
        loadData();
      }
    });

    document.getElementById('refresh-btn').addEventListener('click', loadData);

    async function loadData() {
        listDiv.innerHTML = '<p class="text-center text-gray-500">Chargement...</p>';
        const res = await fetch('/api/admin/pending_contributions', { headers: { 'Authorization': currentToken } });
        const data = await res.json();
        
        if(data.length === 0) {
            listDiv.innerHTML = '<p class="text-center text-green-400 text-xl font-bold">Tout est propre ! Aucune demande.</p>';
            return;
        }

        listDiv.innerHTML = data.map(c => `
            <div class="glass p-6 rounded-2xl relative group" id="card-${c.id}">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-lg font-bold text-white">${c.author_name}</p>
                        <p class="text-pink-400 text-sm font-bold uppercase tracking-wider">${c.category} / ${c.exercise}</p>
                    </div>
                    <a href="${c.video_url}" target="_blank" class="text-blue-400 hover:underline text-sm">Voir Vidéo ↗</a>
                </div>

                <div class="bg-black/40 p-4 rounded-lg border border-white/5 mb-4 grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-gray-500">Poids:</span> <span class="text-white font-mono">${c.performance.weight || '-'} kg</span></div>
                    <div><span class="text-gray-500">Reps:</span> <span class="text-white font-mono">${c.performance.reps || '-'}</span></div>
                    <div><span class="text-gray-500">Temps:</span> <span class="text-white font-mono">${c.performance.time || '-'}</span></div>
                    <div><span class="text-gray-500">Dist:</span> <span class="text-white font-mono">${c.performance.distance || '-'}</span></div>
                    <div class="col-span-2"><span class="text-gray-500">Note:</span> <span class="text-gray-300 italic">"${c.performance.message || '...'}"</span></div>
                </div>

                <div class="flex gap-3" id="actions-${c.id}">
                    <button onclick="approve('${c.id}')" class="flex-1 py-3 rounded-lg bg-green-600 hover:bg-green-500 font-bold transition">VALIDER</button>
                    <button onclick="showReject('${c.id}')" class="flex-1 py-3 rounded-lg bg-red-600 hover:bg-red-500 font-bold transition">REFUSER</button>
                </div>

                <!-- Formulaire de rejet caché -->
                <div id="reject-form-${c.id}" class="hidden mt-4 pt-4 border-t border-white/10">
                    <label class="block text-xs text-gray-400 mb-2">Raison du refus :</label>
                    <select id="reason-select-${c.id}" class="w-full bg-black/50 border border-white/20 rounded p-2 text-sm mb-2 text-white">
                        <option value="Vidéo incomplète ou coupée">Vidéo incomplète ou coupée</option>
                        <option value="Amplitude de mouvement insuffisante">Amplitude de mouvement insuffisante</option>
                        <option value="Angle de caméra inadapté">Angle de caméra inadapté</option>
                        <option value="Poids/Charge non vérifiable">Poids/Charge non vérifiable</option>
                        <option value="Autre (Préciser)">Autre (Préciser dans les standards)</option>
                    </select>
                    <div class="flex gap-2">
                        <button onclick="confirmReject('${c.id}')" class="flex-1 py-2 bg-red-600 rounded text-sm font-bold">Confirmer le rejet</button>
                        <button onclick="hideReject('${c.id}')" class="px-4 py-2 bg-white/10 rounded text-sm">Annuler</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Fonctions globales pour les boutons onclick
    window.approve = async (id) => {
        if(!confirm("Valider cette perf ?")) return;
        document.getElementById(`card-${id}`).style.opacity = "0.5";
        await fetch(`/api/admin/approve_contribution/${id}`, { 
            method: 'POST', 
            headers: { 'Authorization': currentToken } 
        });
        document.getElementById(`card-${id}`).remove();
    };

    window.showReject = (id) => {
        document.getElementById(`actions-${id}`).classList.add('hidden');
        document.getElementById(`reject-form-${id}`).classList.remove('hidden');
    };

    window.hideReject = (id) => {
        document.getElementById(`actions-${id}`).classList.remove('hidden');
        document.getElementById(`reject-form-${id}`).classList.add('hidden');
    };

    window.confirmReject = async (id) => {
        const reason = document.getElementById(`reason-select-${id}`).value;
        const fd = new FormData();
        fd.append('reason', reason);

        document.getElementById(`card-${id}`).style.opacity = "0.5";
        await fetch(`/api/admin/reject_contribution/${id}`, { 
            method: 'POST', 
            headers: { 'Authorization': currentToken },
            body: fd
        });
        document.getElementById(`card-${id}`).remove();
    };
  </script>
</body>
</html>