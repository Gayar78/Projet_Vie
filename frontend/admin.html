<!DOCTYPE html>
<html lang="fr" class="scrollbar-hide">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Panel Admin - DraftPrime</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-[#0f0f1b] to-[#1a1a2e] text-gray-100 font-sans min-h-screen">

  <div id="app" class="container mx-auto p-8">
    <h1 class="text-3xl font-bold mb-6 text-pink-400">Panel Administrateur</h1>

    <div id="login-admin" class="max-w-md bg-gradient-to-br from-white/70 to-white/40 backdrop-blur-xl border border-white/30 shadow-lg p-6 rounded-lg">
      <p class="mb-4">Tu dois te connecter avec ton compte admin Firebase.</p>
      <form id="login-form" class="space-y-4">
        <label class="block">Email</label>
        <input name="email" type="email" class="w-full px-3 py-2 rounded-lg bg-gradient-to-br from-white/60 to-white/40 border border-black/10 focus:ring-pink-500" required>

        <label class="block">Mot de passe</label>
        <input name="password" type="password" class="w-full px-3 py-2 rounded-lg bg-gradient-to-br from-white/60 to-white/40 border border-black/10 focus:ring-pink-500" required>

        <button class="w-full py-2 rounded-lg btn-glass ">
          Connexion Admin
        </button>
        <p id="login-error" class="text-red-400 text-sm"></p>
      </form>
    </div>

    <div id="contributions-list" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl ">Contributions en attente</h2>
        <button id="refresh-btn" class="px-4 py-2 rounded-lg bg-gradient-to-br from-white/70 to-white/40 backdrop-blur-xl border border-white/30 shadow-lg hover:bg-white/20">
          Rafraîchir
        </button>
      </div>
      <div id="list-container" class="space-y-4">
        </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    // Colle ta config Firebase ici (la même que dans vite.config.mjs)
    const firebaseConfig = {
      apiKey: "AIzaSyDOqn7DJSB-FtTfSj1-6RE8vzznyxNhjNw",
      authDomain: "projetvie-212e4.firebaseapp.com",
      projectId: "projetvie-212e4",
    };

    // Initialisation
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---------- DOM Elements ----------
    const loginDiv = document.getElementById('login-admin');
    const contribDiv = document.getElementById('contributions-list');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const listContainer = document.getElementById('list-container');
    const refreshBtn = document.getElementById('refresh-btn');



    let currentToken = null; // Pour stocker le token d'authentification

    // ---------- 1. Logique de Connexion ----------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;
      loginError.textContent = '';

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // Le onAuthStateChanged va gérer l'affichage
      } catch (error) {
        console.error(error);
        loginError.textContent = "Erreur: " + error.message;
      }
    });

    // ---------- 2. Gestion de l'état (Connecté / Déconnecté) ----------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // L'utilisateur est connecté
        currentToken = await user.getIdToken();
        loginDiv.classList.add('hidden');
        contribDiv.classList.remove('hidden');
        loadContributions(); // On charge les contributions
      } else {
        // L'utilisateur est déconnecté
        currentToken = null;
        loginDiv.classList.remove('hidden');
        contribDiv.classList.add('hidden');
      }
    });

    // ---------- 3. Charger les contributions ----------
    const loadContributions = async () => {
      if (!currentToken) return;
      listContainer.innerHTML = '<p>Chargement...</p>';

      try {
        const res = await fetch('/api/admin/pending_contributions', {
          headers: { 'Authorization': currentToken }
        });

        if (res.status === 403) {
          listContainer.innerHTML = '<p class="text-red-400">Erreur: Tu es connecté, mais tu n\'es pas l\'admin configuré dans main.py.</p>';
          return;
        }
        if (!res.ok) throw new Error(await res.text());

        const contributions = await res.json();
        renderContributions(contributions);

      } catch (error) {
        listContainer.innerHTML = `<p class="text-red-400">Erreur: ${error.message}</p>`;
      }
    };

    refreshBtn.addEventListener('click', loadContributions);

    // ---------- 4. Afficher les contributions ----------
    const renderContributions = (contributions) => {
      if (contributions.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400">Rien à valider. C\'est du bon travail !</p>';
        return;
      }

      listContainer.innerHTML = contributions.map(c => {

        // 1. Afficher la performance de l'utilisateur
        const perf = c.performance || {};
        const perfHtml = [
            perf.weight ? `Poids: <strong>${perf.weight} kg</strong>` : '',
            perf.reps ? `Reps: <strong>${perf.reps}</strong>` : '',
            perf.distance ? `Distance: <strong>${perf.distance} km</strong>` : '',
            perf.time ? `Temps: <strong>${perf.time}</strong>` : '',
            perf.message ? `Message: <strong>${perf.message}</strong>` : ''
        ].filter(Boolean).join(' / '); // Filtre les champs vides

        return `
        <div class="bg-gradient-to-br from-white/60 to-white/30 backdrop-blur-xl border border-white/30 shadow-md p-4 rounded-lg border border-white/10" data-id="${c.id}">

          <p class="text-sm text-gray-400">De: <strong>${c.author_name}</strong></p>
          <p>Exercice: <strong>${c.category} / ${c.exercise}</strong></p>
          <a href="${c.video_url}" target="_blank" class="text-pink-400 hover:underline">
            Voir la vidéo ↗
          </a>
          <p class="mt-2">Consentement: <strong>${c.consent ? 'Oui' : 'Non'}</strong></p>

          <hr class="border-white/10 my-3">

          <p class="">Performance soumise à valider :</p>
          <p class="text-lg text-yellow-400 p-2 bg-black/20 rounded-lg">
            ${perfHtml || 'Aucune donnée'}
          </p>

          <hr class="border-white/10 my-4">

          <div class="flex gap-4 items-center">
            <button data-action="approve" data-id="${c.id}"
                    class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 ">
              Approuver
            </button>
            <button data-action="reject" data-id="${c.id}"
                    class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 ">
              Rejeter
            </button>
            <span id="status-${c.id}" class="text-sm mt-2 block"></span>
          </div>
        </div>
      `}).join('');
    };

    // ---------- 5. Gérer les clics "Approuver" / "Rejeter" ----------
    listContainer.addEventListener('click', async (e) => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;

      const action = button.dataset.action;
      const id = button.dataset.id;
      const card = button.closest('div[data-id]');
      const statusEl = document.getElementById(`status-${id}`);

      button.disabled = true;
      statusEl.textContent = 'Traitement...';

      try {
        if (action === 'approve') {

              const res = await fetch(`/api/admin/approve_contribution/${id}`, {
                method: 'POST',
                headers: {
                  'Authorization': currentToken,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // On envoie un corps vide
              });

              if (!res.ok) throw new Error(await res.text());

              const data = await res.json();

              // NOUVELLE LOGIQUE D'AFFICHAGE
              if (data.is_personal_record) {
                  // C'est un nouveau record !
                  statusEl.textContent = `Approuvé! Nouveau Record. +${data.points_added_to_total} pts ajoutés. (Niv: ${data.level_equivalent})`;
                  card.classList.add('border-green-500');
              } else {
                  // C'est validé, mais ce n'est pas un record
                  statusEl.textContent = `Approuvé (Pas un record). 0 pts ajoutés. (Niv: ${data.level_equivalent})`;
                  card.classList.add('border-gray-500');
              }


        } else if (action === 'reject') {
            const res = await fetch(`/api/admin/reject_contribution/${id}`, {
                method: 'POST',
                headers: { 'Authorization': currentToken }
            });

          if (!res.ok) throw new Error(await res.text());
          statusEl.textContent = 'Rejeté.';
          card.classList.add('border-red-500');
        }

        // On fait disparaître la carte après 2 secondes
        setTimeout(() => card.style.display = 'none', 2000);

      } catch (error) {
        statusEl.textContent = `Erreur: ${error.message}`;
        button.disabled = false;
      }
    });

  </script>
</body>
</html>